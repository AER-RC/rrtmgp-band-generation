#!/bin/csh -f

# Set up the initial run beforehand with 
# script.gen_2band $1

# To run : script.planck_multilevel band_dir atmos_level

# Note :input_param must be set so that only key species are included.
# When running lower atmosphere (WHICH SHOULD BE DONE FIRST!!!!!)
# set isortplanck(2) to match level chosen in taumol.f
# When running upper atmosphere set isortplanck(1) to match level 
# determined by running this script on the lower atmosphere and
# then running plot_select_pl.pro

# Script runs LBLRTM for the three standard atmospheres with all species
# zeroed out except for the key species, then obtains fluxes
# Script also runs RRTM with the same atmospheres and species as for LBLRTM, but
# with sorting for the Planck function specified at six (lower atmosphere) or
# nine (upper atmosphere)  different levels

# plot_select_pl.pro then compares the output from the LBLRTM and RRTM flux calculation

# Karen Cady-Pereira   September 2000


cd $1
set atmos_level = $2
set atm = (MLS SAW TRP)

# Run  script to get LBL ONLY_KEY validation runs; Name output with distinct ending (_ONLY_KEY)

if ($atmos_level == "LOWER") then
   foreach i ($atm)

# build correct input_param and tape5 for ONLY_KEY OD files
# note that other input files for flux calculations are generated by gen_2band

      \cp ../input_param .
      set lowatm = `echo $i | tr "[A-Z]" "[a-z]"`
      echo " &atm atmos='"$lowatm"' atmos_level='"$atmos_level"' /" >> input_param
      echo " &atm atmos='"$lowatm"' atmos_level='"$atmos_level"' /" 

      cp ../central_exec_scripts/template_${lowatm} .
      write_tape5_od_only_key < input_param
      \rm template_${lowatm}

# run LBLRTM and radsum to calculate  fluxes

#      cd ../lbl_f90
#      echo "Running OD"
#      \cp ../$1/TAPE5_${i}OD_ONLY_KEY TAPE5
#      lblrtm_f90
#      echo "Running RD"
#      \cp ../$1/TAPE5_${i}RD TAPE5
#      lblrtm_f90
#      echo "Running RAD"
#      \cp ../$1/RADINIT_${i} RADINIT
#      radsum.x
#      \mv flxupdn.dat OUTPUT_LBLRTM_${i}_ONLY_KEY
#      echo Finish ${i}
#      \cp OUTPUT_LBLRTM_${i}_ONLY_KEY ../$1/.
#      cleanup_lbl
#      cd ../$1
#      \rm input_param
   end
endif

if ($2 == "UPPER" ) then
   set lower_planck = `nawk 'NR == 9 {print $4}' ../input_param` 
   echo $lower_planck
   \cp kg_planck_LOWER_PL_${lower_planck}.f kg_planck_lower.f 
endif

# Make input_param for other test PL levels and generate Planck function files

cd ..
if ($2 == "LOWER" ) then
   set levels = (1 3 5 7 9 11)
else if ($2 == "UPPER" ) then
   set levels = (1 6 11 16 21 26 31 36 41)
else
   echo "Can only run for UPPER or LOWER as argument 2"
   echo "Will exit"
   exit
endif

foreach  i ( $levels )
  echo PL_$i
  nawk -v level=$i -v atmos=$2 ' \
	  NR!=9 {print}\
          NR==9 && atmos=="LOWER" {print " "$1, $2, $3, level, $5, $6, $7"/"}\
          NR==9 && atmos=="UPPER" {print " "$1, $2, $3, $4, $5, $6, level"/"}  ' input_param > input_param_$2_PL_$i
  \cp input_param_$2_PL_$i $1/input_param
  \mv input_param_$2_PL_$i $1/input_param_$2_PL_$i
  script.gen_planck_only_key.flux $1 PL_$i $2
end

echo Finished
